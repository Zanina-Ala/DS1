// Jenkinsfile.dev - Full build on push to dev (includes parallel matrix)
pipeline {
  agent any
  triggers {
    // configure GitHub push trigger to this pipeline or use pollSCM
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Setup') {
      steps {
        sh 'npm ci'
      }
    }
    stage('Parallel Build Matrix') {
      parallel {
        node18 {
          stages {
            stage('Build-node18') {
              steps {
                sh 'echo "Building with Node 18 (simulated)"'
                sh 'npm run build'
              }
            }
          }
        }
        node20 {
          stages {
            stage('Build-node20') {
              steps {
                sh 'echo "Building with Node 20 (simulated)"'
                sh 'npm run build'
              }
            }
          }
        }
      }
    }
    stage('Run (Docker)') {
      steps {
        script {
          def img = docker.build("react-ci-dev:${env.BUILD_ID}")
          docker.withRun(img, "-p 8081:80") {
            sh 'sleep 2'
            sh 'bash smoke/smoke_test.sh http://localhost 8081'
          }
        }
      }
    }
    stage('Archive Artifacts') {
      steps {
        sh 'mkdir -p artifacts; cp -r dist artifacts || true; tar -czf artifacts_dev_${BUILD_ID}.tar.gz artifacts'
        archiveArtifacts artifacts: 'artifacts_dev_*.tar.gz'
      }
    }
    stage('Cleanup') {
      steps { sh 'docker image prune -af || true' }
    }
  }
  post {
    success { echo "Dev pipeline success" }
    failure { echo "Dev pipeline failed" }
  }
}
